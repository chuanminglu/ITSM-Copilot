# ADR-001：ITSM智能辅助浏览器插件架构与技术选型

| 属性               | 内容                              |
| ------------------ | --------------------------------- |
| **ADR编号**  | ADR-001                           |
| **状态**     | 提议中                            |
| **决策日期** | 2025-12-09                        |
| **决策人**   | 架构组                            |
| **关联需求** | ITSM系统需求提交优化_用户故事文档 |
| **替代ADR**  | -                                 |

---

## 背景

### 业务需求

广东省电信ITSM系统汇聚了上百套IT系统的需求流转，当前存在两大核心痛点：

1. **P1痛点 - 系统选择错误（选错率约40%）**

   - 需求提出人多为一线人员和业务人员，对系统了解不足
   - 无法准确选择"首要系统"，导致需求分派环节反复
   - 系统众多（30+），权限和能力各有不同，错派和回退频繁
2. **P2痛点 - 需求描述简单（澄清轮次平均2.5次）**

   - 需求通常为"一句话需求"，相关事项描述不准确
   - 需求区分为功能开发类、数据类、配置类及流程改造等类别，提出人难以理解
   - IT支持部门在需求澄清与需求理解方面花费大量时间

**核心功能需求**：

- 智能系统推荐与选择（基于关键词搜索、拼音搜索、模糊匹配）
- 智能模板推荐（自动识别Bug反馈/功能优化/新功能等场景）
- 结构化需求引导填写（提供背景/目标/场景/验收标准字段）
- 实时质量检测与评分（边写边改，预防低质量提交）

### 技术约束

1. **实现方式约束**

   - 必须使用浏览器插件实现（Chrome/Edge扩展）
   - 尽量不要有后端服务（最小化架构复杂度）
   - 以侧边栏形式展现，不允许修改ITSM系统架构
2. **资源与时间约束**

   - 团队规模：2人（开发A、开发B）
   - 开发周期：10个工作日
   - 技术选型必须简单，降低学习成本
3. **环境约束**

   - ITSM为成熟系统，无法进行架构级或大功能级修改
   - 需兼容Chrome 90+和Edge 90+浏览器
   - 需考虑网络环境可能受限情况

### 当前痛点

**技术维度痛点**：

- 传统ITSM系统无智能化能力，完全依赖人工选择和填写
- 系统下拉框包含30+选项，用户查找困难
- 缺少结构化引导，用户不知道需求该写什么内容
- 提交前无质量检查机制，低质量需求直接进入流转流程

**解决目标**：

- 系统选择错误率从40%降至10%（降低75%）
- 需求澄清轮次从2.5次降至1次（降低60%）
- 需求退回率从40%降至10%（降低75%）
- 需求填写时间从平均10分钟降至3分钟（提升70%效率）

---

## 决策

**选择方案**：Chrome/Edge浏览器扩展 + Sidebar侧边栏架构 + Content Script注入 + DeepSeek大模型API

**核心理由**：
选择Chrome扩展+Sidebar架构，因为其无需后端服务、开发周期短（2人10天可完成）、用户体验好（侧边栏不干扰ITSM主界面），且通过Content Script可灵活操作ITSM页面DOM；选择DeepSeek大模型API，因为其性价比极高（0.14元/百万Token）、准确率满足需求（85%>70%）、有完善中文文档支持，适合快速开发场景。

---

## 候选方案

### 架构层面候选方案

| 维度                   | 方案A：Chrome扩展+Sidebar | 方案B：Greasemonkey脚本  | 方案C：浏览器插件+独立后端 |
| ---------------------- | ------------------------- | ------------------------ | -------------------------- |
| **开发成本**     | 低（2人10天可完成）       | 极低（2人5天）           | 高（2人20天+服务器）       |
| **部署成本**     | 无需服务器                | 无需服务器               | 需要服务器（月500元+）     |
| **用户体验**     | 优秀（原生Sidebar UI）    | 一般（页面内嵌入元素）   | 优秀（独立UI）             |
| **维护成本**     | 低（Chrome API稳定）      | 中（需适配ITSM DOM变化） | 高（前后端分离维护）       |
| **数据存储**     | LocalStorage（5MB）       | LocalStorage（5MB）      | 后端数据库（无限制）       |
| **兼容性**       | Chrome/Edge 90+           | 所有浏览器+油猴          | Chrome/Edge/Firefox        |
| **ITSM页面操作** | Content Script灵活操作    | DOM直接操作              | 需跨域通信                 |
| **功能扩展性**   | 中（受限于LocalStorage）  | 低（受限于脚本沙箱）     | 高（可集成复杂功能）       |
| **是否满足约束** | ✅ 无后端、10天可完成     | ✅ 无后端、但用户体验差  | ❌ 需要后端服务            |

### AI模型层面候选方案

| 维度                   | 方案A：DeepSeek API      | 方案B：ChatGPT-4 API      | 方案C：Qwen本地部署         |
| ---------------------- | ------------------------ | ------------------------- | --------------------------- |
| **成本**         | 0.14元/百万Token         | 7元/百万Token             | 硬件成本5000元+             |
| **准确率**       | 85%（官方测评）          | 90%（行业领先）           | 75%（需微调）               |
| **响应速度**     | P95<2秒                  | P95<3秒                   | P95<1秒（本地）             |
| **网络要求**     | 需联网（API调用）        | 需联网（API调用）         | 无需联网                    |
| **学习成本**     | 低（中文文档）           | 中（英文文档为主）        | 高（需GPU调优）             |
| **月成本估算**   | 约10元（预计100万Token） | 约700元（预计100万Token） | 电费约50元+硬件折旧         |
| **适配性**       | 完美适配Prompt工程       | 完美适配Prompt工程        | 需微调+Prompt优化           |
| **是否满足约束** | ✅ 成本低、准确率满足    | ❌ 成本太高               | ⚠️ 学习成本高、10天难完成 |

### 数据存储层面候选方案

| 维度                   | 方案A：LocalStorage           | 方案B：IndexedDB | 方案C：云端存储   |
| ---------------------- | ----------------------------- | ---------------- | ----------------- |
| **存储容量**     | 5-10MB                        | 数百MB           | 无限制            |
| **性能**         | 同步API（快）                 | 异步API（快）    | 网络延迟（慢）    |
| **开发复杂度**   | 低（简单键值对）              | 中（需封装API）  | 高（需后端+鉴权） |
| **数据持久化**   | 浏览器清缓存丢失              | 浏览器清缓存丢失 | 永久保存          |
| **是否满足约束** | ✅ 简单、够用（系统列表<1MB） | ✅ 可用但复杂    | ❌ 需要后端服务   |

---

## 权衡分析

### 架构方案：Chrome扩展+Sidebar

**✅ 优势**：

1. **无需后端服务**：完全满足"尽量不要有后端服务"约束，部署成本为0，无需服务器运维
2. **开发周期短**：Chrome Extension API成熟稳定，2人10天可完成MVP（开发A 8天+开发B 8天+集成2天=18人天<20人天预算）
3. **用户体验优秀**：原生Sidebar UI，不干扰ITSM主界面，支持展开/收起，与ITSM页面并排显示
4. **灵活操作ITSM页面**：Content Script可直接操作DOM（选择下拉框、填充文本框），无需跨域通信
5. **浏览器兼容性好**：Chrome和Edge共享Chromium内核，Manifest V3规范一次开发双平台可用

**❌ 劣势**：

1. **数据存储容量受限**：LocalStorage只有5-10MB，无法存储大量历史数据
2. **功能扩展受限**：复杂功能（如需求知识图谱、团队协作）需要后端支持
3. **数据持久化风险**：用户清除浏览器缓存会丢失数据

**缓解措施**：

- 针对存储容量：MVP阶段只存储系统列表（约500KB）、模板配置（约200KB）、用户行为日志（最多1MB），总计<2MB，远低于5MB限制；如未来扩展，可升级到IndexedDB（数百MB）
- 针对功能扩展：MVP阶段聚焦P0功能（系统选择+需求引导），未来V2版本再考虑后端服务
- 针对数据持久化：在用户首次使用时提示"请勿清除浏览器缓存"，提供数据导出/导入功能作为兜底

### AI模型方案：DeepSeek API

**✅ 优势**：

1. **性价比极高**：0.14元/百万Token，预计月消耗100万Token（每天3333 Token × 30天），月成本仅14元，远低于ChatGPT的700元
2. **准确率满足需求**：官方测评85%，高于70%要求15个百分点，有充足缓冲空间
3. **学习成本低**：完善的中文文档和示例代码，开发人员2天内可上手
4. **响应速度快**：P95<2秒，满足实时推荐场景（用户输入标题后2秒内推荐模板）
5. **Prompt工程友好**：支持System/User/Assistant角色，易于优化Prompt提升准确率

**❌ 劣势**：

1. **需要联网**：API调用依赖网络，培训环境网络受限可能影响使用
2. **API稳定性未知**：DeepSeek为新产品（2024年发布），可能有API不稳定情况
3. **准确率未实测**：85%为官方测评数据，实际场景（ITSM系统推荐）准确率需验证

**缓解措施**：

- 针对网络依赖：Day 2提前测试网络环境，如受限则准备Qwen本地部署备选方案（1天内可切换）
- 针对API稳定性：设置3次重试机制+5秒超时，失败时降级到规则引擎（关键词匹配）
- 针对准确率验证：Day 3-4进行50条真实需求测试，如准确率<70%则优化Prompt或切换到ChatGPT（成本增加但可接受）

### 数据存储方案：LocalStorage

**✅ 优势**：

1. **开发简单**：浏览器原生API，`localStorage.setItem/getItem`即可，无需额外库
2. **性能优秀**：同步API，读写延迟<1ms，满足实时搜索场景
3. **零成本**：无需服务器，无需数据库，完全本地存储

**❌ 劣势**：

1. **容量受限**：5-10MB，无法存储大量历史数据
2. **数据持久化风险**：清除浏览器缓存会丢失数据
3. **无法跨设备同步**：用户换电脑后需重新配置

**缓解措施**：

- 针对容量限制：MVP阶段只存储必要数据（系统列表、模板、配置），控制在2MB以内
- 针对数据丢失：提供数据导出功能（JSON文件），用户可手动备份
- 针对跨设备同步：V2版本考虑Chrome Sync API或云端存储

---

## 后果

### 正面影响

1. **业务价值快速验证**：10天MVP交付，快速验证AI辅助ITSM需求提交的价值，为后续投资提供决策依据
2. **开发成本极低**：无需服务器（节省月500元+运维成本），AI成本月14元，总成本<100元/月
3. **用户体验显著提升**：
   - 系统选择时间从2分钟降至30秒（提升75%）
   - 需求填写时间从10分钟降至3分钟（提升70%）
   - 需求退回率从40%降至10%（降低75%）
4. **技术债务可控**：Sidebar+DeepSeek方案技术栈简单，2人团队可维护，未来升级到后端架构成本可控
5. **知识沉淀**：ADR文档记录技术选型过程，为团队积累浏览器扩展+AI集成的经验资产

### 负面影响与风险

| 风险                           | 概率 | 影响 | 风险等级 | 应对措施                                       |
| ------------------------------ | ---- | ---- | -------- | ---------------------------------------------- |
| **DeepSeek API不稳定**   | 中   | 高   | 🔴 高    | 准备Qwen本地部署备选，1天内可切换              |
| **推荐准确率<70%**       | 中   | 高   | 🔴 高    | Day 3-4测试验证，Prompt优化，必要时切换ChatGPT |
| **LocalStorage数据丢失** | 低   | 中   | 🟡 中    | 提供数据导出功能，用户手动备份                 |
| **ITSM页面DOM结构变化**  | 低   | 中   | 🟡 中    | 使用灵活选择器（data-*属性），定期回归测试     |
| **用户不习惯侧边栏**     | 低   | 低   | 🟢 低    | 提供快捷键切换（Alt+S），首次使用引导          |
| **Chrome扩展审核不通过** | 低   | 中   | 🟡 中    | MVP阶段手动安装（开发者模式），V2再上架商店    |

---

## 回滚条件

### 触发条件（满足任一条件即触发回滚）

#### 条件1：推荐准确率不达标

**具体指标**：系统推荐Top3准确率连续3天<70%

- **监控方式**：每日人工抽检50条需求提交记录，统计系统推荐准确率（用户最终选择的系统是否在推荐Top3中）
- **判定周期**：每日18:00统计当日数据
- **责任人**：AI工程师（开发A）
- **判定标准**：连续3天准确率<70%即触发回滚

**示例数据**：

```
Day 3：准确率68%（34/50）
Day 4：准确率65%（32/50）
Day 5：准确率69%（34/50）
→ 连续3天<70%，触发回滚
```

#### 条件2：DeepSeek API成本超标

**具体指标**：月度API调用成本>预算50元（超预算250%）

- **监控方式**：DeepSeek控制台账单监控，每周一统计累计消耗
- **判定周期**：每周一9:00检查
- **责任人**：项目经理
- **判定标准**：月中（Day 15）成本>25元，或月末（Day 30）成本>50元

**示例数据**：

```
预算：月14元（100万Token × 0.14元）
超标阈值：月50元（预算×3.5倍）
Day 15累计：30元 → 超标，触发回滚
```

#### 条件3：DeepSeek API可用性<95%

**具体指标**：API调用失败率（含超时）>5%，持续24小时

- **监控方式**：浏览器插件后台记录每次API调用结果（成功/失败/超时），计算失败率
- **判定周期**：每小时统计过去24小时数据
- **责任人**：AI工程师（开发A）
- **判定标准**：24小时滚动窗口内失败率>5%

**示例数据**：

```
过去24小时调用1000次，失败60次 → 失败率6% → 触发回滚
```

#### 条件4：用户满意度<3分

**具体指标**：需求提交后用户满意度调查<3分（5分制），持续1周

- **监控方式**：需求提交后弹窗询问"插件帮助程度？1-5分"
- **判定周期**：每周五统计本周数据
- **责任人**：项目经理
- **判定标准**：连续1周平均分<3分

**示例数据**：

```
Week 1：平均2.8分（140人×2.8分 / 50人响应）
Week 2：平均2.7分
→ 连续2周<3分，触发回滚
```

### 回滚方案

#### 回滚方案A：切换到Qwen本地部署（针对API不稳定/成本超标）

**执行步骤**：

1. **环境准备**（预计耗时：2小时）

   - 确认GPU服务器可用（Tesla T4 16GB或同等配置）
   - 安装CUDA 11.8、PyTorch 2.0
   - 下载Qwen-7B-Chat模型（约14GB，预计1小时）
2. **模型部署**（预计耗时：3小时）

   - 部署FastAPI推理服务（使用vLLM加速）
   - 配置Nginx反向代理（端口8080）
   - 压力测试：验证P95延迟<2秒（100并发）
3. **插件代码调整**（预计耗时：2小时）

   - 修改API调用地址：`https://api.deepseek.com` → `http://内网IP:8080`
   - 调整Prompt格式适配Qwen（System/User角色）
   - 回归测试：验证系统推荐、模板推荐功能
4. **上线验证**（预计耗时：1小时）

   - 灰度发布：先给10名用户测试
   - 监控准确率、响应时间
   - 确认无问题后全量发布

**总回滚时间**：1个工作日（8小时）

**成本变化**：

- DeepSeek成本：月14元 → 0元
- Qwen成本：硬件折旧月200元 + 电费月50元 = 月250元
- 成本增加：月236元（可接受）

#### 回滚方案B：切换到ChatGPT-4 API（针对准确率不达标）

**执行步骤**：

1. **API配置**（预计耗时：30分钟）

   - 申请OpenAI API Key
   - 配置代理服务器（科学上网）
   - 设置预算上限（月500元）
2. **插件代码调整**（预计耗时：1小时）

   - 修改API调用地址和鉴权方式
   - 调整Prompt格式（ChatGPT-4要求更精简）
   - 设置temperature=0.3（降低随机性）
3. **上线验证**（预计耗时：30分钟）

   - 测试50条需求，验证准确率>85%
   - 监控API响应时间<3秒
   - 全量发布

**总回滚时间**：0.5个工作日（4小时）

**成本变化**：

- DeepSeek成本：月14元 → 0元
- ChatGPT-4成本：月700元（100万Token × 7元）
- 成本增加：月686元（需管理层审批）

#### 回滚方案C：降级到规则引擎（针对AI完全不可用）

**执行步骤**：

1. **规则引擎开发**（预计耗时：4小时）

   - 基于关键词匹配实现系统推荐（无AI）
   - 基于模板库实现模板推荐（固定规则）
   - 去掉AI辅助生成功能
2. **准确率验证**（预计耗时：2小时）

   - 测试100条需求，预计准确率60-65%
   - 低于70%目标，但可保底使用
3. **上线验证**（预计耗时：1小时）

   - 灰度发布测试
   - 全量发布

**总回滚时间**：1个工作日（7小时）

**成本变化**：

- AI成本：月14元 → 0元
- 功能降级：准确率85% → 60%（用户体验下降）

---

## 实施计划

### Day 1-2：环境搭建与技术验证

**开发A任务**（2天）：

- 搭建Chrome扩展项目框架（Manifest V3）
- 实现Sidebar侧边栏UI（React组件）
- 配置LocalStorage数据存储
- 集成DeepSeek API（测试系统推荐功能）

**开发B任务**（2天）：

- 准备系统列表数据（30个系统分类+关键词）
- 设计模板配置（Bug反馈/功能优化/新功能3个模板）
- 编写Prompt模板（系统推荐、场景识别）
- 测试DeepSeek API准确率（50条样本）

**里程碑**：✅ 技术栈验证完成，DeepSeek准确率≥70%

### Day 3-5：核心功能开发（系统选择）

**开发A任务**（3天）：

- US-001：系统智能搜索与选择（2天）
- US-002：系统选择信心度反馈（1天）

**开发B任务**（3天）：

- US-003：智能模板推荐匹配场景（1.5天）
- US-004：结构化引导填写需求（前2天，2天总计）

**里程碑**：✅ 系统选择+模板引导完成

### Day 6-8：质量检测与预防（需求质量）

**开发A任务**（3天）：

- US-006：实时完整性检测提示（2天）
- US-007：需求质量评分可视化（1.5天，前1天）

**开发B任务**（3天）：

- US-004：结构化引导填写需求（后0.5天，剩余部分）
- US-005：需求示例库降低门槛（1.5天）
- US-007：需求质量评分可视化（0.5天，后半天）
- US-008：提交前缺失警告预防（1天）

**里程碑**：✅ 质量检测完成

### Day 9-10：集成测试与部署

**开发A & B共同任务**（2天）：

- US-009：插件集成测试与部署（2天）
  - Day 9：功能集成测试、兼容性测试、性能测试
  - Day 10：用户验收测试（UAT）、插件打包、部署文档

**里程碑**：✅ MVP交付

### 资源分配汇总

| 阶段     | 时间 | 开发A任务               | 开发B任务                                            | 里程碑               |
| -------- | ---- | ----------------------- | ---------------------------------------------------- | -------------------- |
| Day 1-2  | 2天  | 环境搭建+API集成        | 数据准备+Prompt设计                                  | ✅ 技术验证完成      |
| Day 3-5  | 3天  | US-001, US-002          | US-003, US-004（前2天）                              | ✅ 系统选择+模板引导 |
| Day 6-8  | 3天  | US-006, US-007（前1天） | US-004（后0.5天）, US-005, US-007（后0.5天）, US-008 | ✅ 质量检测完成      |
| Day 9-10 | 2天  | US-009（集成测试）      | US-009（集成测试）                                   | ✅ MVP交付           |

**总工时**：

- 开发A：2 + 3 + 3 + 2 = 10天 ✅
- 开发B：2 + 3 + 3 + 2 = 10天 ✅

---

## 相关文档

- **需求文档**：[ITSM系统需求提交优化_用户故事文档.md](./ITSM系统需求提交优化_用户故事文档.md)
- **需求痛点**：[需求痛点.md](./需求痛点.md)
- **技术调研**：【待补充】DeepSeek技术评估报告（Day 2完成）
- **Prompt模板**：【待补充】系统推荐Prompt模板（Day 2完成）
- **测试报告**：【待补充】准确率测试报告（Day 4完成）
- **成本监控**：【待补充】DeepSeek API月度账单（Day 30完成）
- **相关ADR**：暂无（本项目首个ADR）

---

## 附录：技术栈详细说明

### 前端技术栈

| 技术                                   | 版本 | 用途           | 选择理由                 |
| -------------------------------------- | ---- | -------------- | ------------------------ |
| **Chrome Extension Manifest V3** | 最新 | 浏览器扩展规范 | Google官方推荐，安全性高 |
| **React**                        | 18.x | Sidebar UI框架 | 组件化开发，开发效率高   |
| **TypeScript**                   | 5.x  | 类型检查       | 提升代码质量，减少Bug    |
| **TailwindCSS**                  | 3.x  | UI样式         | 快速开发，响应式设计     |
| **Vite**                         | 5.x  | 构建工具       | 开发体验好，构建速度快   |
| **Fuse.js**                      | 7.x  | 模糊搜索引擎   | 轻量级，支持拼音搜索     |

### AI技术栈

| 技术                         | 版本 | 用途               | 选择理由                     |
| ---------------------------- | ---- | ------------------ | ---------------------------- |
| **DeepSeek API**       | V1   | 大语言模型         | 性价比高（0.14元/百万Token） |
| **Prompt Engineering** | -    | 场景识别、模板推荐 | 无需微调，快速迭代           |

### 数据存储

| 技术                   | 容量   | 用途                             | 选择理由              |
| ---------------------- | ------ | -------------------------------- | --------------------- |
| **LocalStorage** | 5-10MB | 系统列表、模板配置、用户行为日志 | 浏览器原生API，零成本 |

### 开发工具

| 工具                      | 用途           |
| ------------------------- | -------------- |
| **VS Code**         | 代码编辑器     |
| **Chrome DevTools** | 调试与性能分析 |
| **Selenium**        | 自动化测试     |
| **Git**             | 版本控制       |

---

## 版本历史

| 版本 | 日期       | 更新内容                                 | 作者     |
| ---- | ---------- | ---------------------------------------- | -------- |
| v1.0 | 2025-12-09 | 初始版本，基于RTGO框架和用户故事文档生成 | AI架构师 |

---

**📌 注意事项**：

1. 本ADR需在Day 1技术验证后提交技术委员会评审
2. 如DeepSeek准确率测试（Day 2）<70%，立即启动回滚方案B（切换ChatGPT）
3. 所有成本数据需每周更新，确保在预算内
4. MVP交付后（Day 10），需进行1个月试运行，收集用户反馈后决定是否继续投资V2版本
5. 本ADR状态将在技术委员会评审后更新为"已接受"或"已废弃"
